# Telegram Blog Bot (Тестовое Задание)

Этот проект представляет собой Telegram-бота для отображения постов блога, управляемых через API-админку.

## Описание

Проект состоит из двух основных частей:
1.  **API-сервер (FastAPI):** Предоставляет RESTful API для управления постами блога (добавление, чтение, обновление, удаление) с полноценной аутентификацией и улучшенной обработкой ошибок.
2.  **Telegram-бот (python-telegram-bot):** Взаимодействует с API для отображения постов пользователям Telegram, предоставляя информативную обратную связь.

## Функционал

### API (Админка)
*   **CRUD-операции для постов:**
    *   `POST /posts/`: Создать новый пост. **(Требуется аутентификация)**
    *   `GET /posts/`: Получить список всех постов.
    *   `GET /posts/{post_id}`: Получить пост по ID.
    *   `PUT /posts/{post_id}`: Обновить существующий пост. **(Требуется аутентификация)**
    *   `DELETE /posts/{post_id}`: Удалить пост. **(Требуется аутентификация)**
*   **Аутентификация:** Реализована через JWT (Bearer Token) с эндпоинтом `/token` для получения токена (логин/пароль `admin`/`securepassword`).
*   **Обработка ошибок:** Глобальные обработчики исключений для `RequestValidationError` (невалидные данные), `HTTPException` и непредвиденных `Exception` (внутренние ошибки сервера) с информативными ответами.
*   **ORM-модель поста:** Заголовок (`title`), Текст (`text`), Дата создания (`created_at`).
*   **Документация API:** Автоматически сгенерированная интерактивная документация доступна через Swagger UI и ReDoc.

### Telegram-бот
*   **Команда `/posts`:** Отображает список заголовков всех доступных постов в виде интерактивных кнопок.
*   **Просмотр поста:** При нажатии на заголовок поста бот показывает его полный текст и дату создания.
*   **Обработка ошибок:** Предоставляет пользователю подробные и понятные сообщения в случае проблем с API или других непредвиденных ситуаций.

## Способ синхронизации данных

Синхронизация данных между Telegram-ботом и веб-сервером (API-админкой) осуществляется с помощью **прямых HTTP-запросов (API-вызовов)**.

*   Веб-сервер на FastAPI является **единственным источником истины** (Single Source of Truth) для всех данных о постах, храня их в базе данных SQLite.
*   Сам Telegram-бот **не хранит собственную копию постов**.
*   Когда боту требуется отобразить посты (например, по команде `/posts` или при нажатии на кнопку), он отправляет **асинхронные HTTP GET-запросы** к соответствующим эндпоинтам FastAPI API (`/posts/` или `/posts/{post_id}`).
*   FastAPI получает эти данные из базы данных и возвращает их боту в виде JSON-ответа, обеспечивая **актуальность информации**.

Такой подход обеспечивает **мгновенную актуальность** данных, так как бот всегда запрашивает самую свежую информацию напрямую из основного источника. Это полностью соответствует требованиям тех-задания о том, что бот должен показывать посты "ровно в том состоянии и количестве, что он создал/обновил/удалил". Данный метод является наиболее **простым и эффективным** для данной задачи, не требуя реализации сложных систем обмена сообщениями или вебхуков, что упрощает разработку и развертывание.

## Технологии

*   **Python:** 3.9+ (проверено на Python 3.13)
*   **Web Framework:** FastAPI
*   **Telegram Bot Library:** `python-telegram-bot`
*   **Database:** SQLite (локальный файл `blog.db`)
*   **ORM/DB Client:** SQLAlchemy, databases
*   **Authentication:** `passlib[bcrypt]` (для хеширования паролей), `python-jose[cryptography]` (для JWT)
*   **HTTP Client:** httpx
*   **Code Quality:** `black` (форматирование), `isort` (сортировка импортов)
*   **Конфигурация:** `.env` файл
*   **Зависимости:** `requirements.txt`

## Как запустить проект

Следуйте этим шагам, чтобы запустить API и Telegram-бота на вашей локальной машине.

### 1. Клонирование репозитория

```bash
git clone https://github.com/kislyakov84/blogtron.git
cd blogtron
Use code with caution.
Markdown
2. Настройка виртуального окружения и установка зависимостей
Настоятельно рекомендуется использовать виртуальное окружение.
# Создать виртуальное окружение
python -m venv .venv

# Активировать виртуальное окружение
# Для Windows:
# .\.venv\Scripts\activate
# Для macOS / Linux:
# source ./.venv/bin/activate

# Установить все зависимости
pip install -r requirements.txt
Use code with caution.
Bash
3. Настройка переменных окружения
Создайте файл .env в корневой директории проекта, скопировав содержимое из .env.template:
cp .env.template .env # Для macOS / Linux
# Для Windows: скопируйте содержимое файла .env.template в новый файл .env
Use code with caution.
Bash
ВАЖНО: Замените YOUR_TELEGRAM_BOT_TOKEN_HERE на ваш реальный токен Telegram-бота, полученный от @BotFather. Также задайте SECRET_KEY — любую длинную случайную строку (например, сгенерированную онлайн) для безопасности JWT-токенов.
# .env
BOT_TOKEN=ВАШ_ТОКЕН_ОТ_BOTFATHER
DATABASE_URL=sqlite:///./blog.db
SECRET_KEY=ДЛИННЫЙ_И_СЛУЧАЙНЫЙ_СЕКРЕТНЫЙ_КЛЮЧ
Use code with caution.
Ini
4. Запуск API-сервера
API-сервер будет работать на http://localhost:8000.
# Убедитесь, что виртуальное окружение активно
python main.py
Use code with caution.
Bash
После запуска API вы сможете получить доступ к его документации:
Swagger UI: http://localhost:8000/docs
ReDoc: http://localhost:8000/redoc
5. Запуск Telegram-бота
Откройте новый терминал (или окно командной строки), активируйте виртуальное окружение и запустите бота.
# Активируйте виртуальное окружение в новом терминале
# Для Windows:
# .\.venv\Scripts\activate
# Для macOS / Linux:
# source ./.venv/bin/activate

# Запустите бота
python bot/main.py
Use code with caution.
Bash
6. Проверка работы
6.1. Аутентификация в API (для CRUD операций)
Для создания, обновления и удаления постов вам необходимо получить Access Token и авторизоваться в Swagger UI.
Получите токен:
Откройте Swagger UI в браузере: http://localhost:8000/docs.
Найдите эндпоинт POST /token (обычно в самом верху).
Нажмите "Try it out".
Используйте следующие учетные данные:
username: admin
password: securepassword
Нажмите "Execute". В ответе скопируйте значение access_token (длинная строка после {"access_token": "..."}).
Авторизуйтесь в Swagger UI:
Вверху страницы Swagger UI нажмите кнопку "Authorize".
В появившемся окне вставьте скопированный access_token в поле "Value" (без слова "Bearer " перед ним).
Нажмите "Authorize", затем "Close".
Теперь все защищенные эндпоинты (POST, PUT, DELETE /posts/) будут доступны.
6.2. Проверка функционала API и бота
Теперь, когда вы авторизованы в Swagger UI:
Создайте, обновите или удалите посты через Swagger UI (http://localhost:8000/docs). Используйте POST /posts/, PUT /posts/{post_id} или DELETE /posts/{post_id} эндпоинты.
Важно: Убедитесь, что вы авторизованы, иначе получите ошибку 401 Unauthorized.
Откройте Telegram и найдите вашего бота по юзернейму (которое вы дали @BotFather).
Отправьте команду /start. Бот должен ответить приветствием.
Отправьте команду /posts. Бот должен показать список созданных вами постов (даже если их нет, он сообщит об этом).
Нажмите на заголовок поста, чтобы увидеть его полный текст и дату создания.
Проверка ошибок: Попробуйте остановить API-сервер и отправить боту /posts для проверки обработки ошибок подключения. Попробуйте удалить пост через API, а затем нажать на его кнопку в боте для проверки обработки 404 ошибки.
Важные примечания
Для Windows используйте PowerShell или Git Bash вместо стандартного CMD для лучшей совместимости с командами.
При изменении кода API (main.py, app/ файлы) сервер Uvicorn должен автоматически перезапуститься благодаря reload=True.
Токен бота можно получить или создать через @BotFather в Telegram.
При первом запуске API-сервер создаст файл базы данных blog.db в корневой директории проекта.
Пользователь по умолчанию для аутентификации в API: admin / securepassword.
Проект использует black и isort для автоматического форматирования кода, обеспечивая его чистоту и читаемость.
